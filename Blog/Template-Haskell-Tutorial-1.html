<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2024-02-03 Sat 20:42 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Template Haskell 旅程 &#x2013; 第一弹</title>
<meta name="author" content="Cycoe" />
<meta name="generator" content="Org Mode" />
<link rel="stylesheet" type="text/css" href="/static/css/default.css" />
<link rel="shortcut icon" type="image/png" href="/static/img/favicon.png"/>
<script language="JavaScript" type="text/javascript" src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script language="JavaScript" type="text/javascript" src="/static/js/main.js"></script>
</head>
<body>
<div id="preamble" class="status">
<div id="top-container">
  <a id="site-name" href="/">Cycoe<span id="at-home">@Home</span></a>
  <div id="banner">Keep It Simple Stupid</div>
</div>

<div id="top-nav">
  <div id="nav-wrapper">
    <div class="nav-btn" id="toc-wrapper">
      <span class="vertical-align">Ξ</span>
      <div id="go-top">
        <a href="javascript:window.scrollTo(0,0)" style="color: black !important; border-bottom: none !important;" class="tooltip" title="Go to the top of the page">
        <span class="top">&uarr;</span>
        </a></div>
    </div>
    <div id="nav-left-wrapper">
      <a class="nav-btn" id="photo-entry" href="/Photo/index.html" title="Photo">Photo</a>
      <a class="nav-btn" id="about-entry" href="/about.html" title="About Me">About</a>
      <div id="nav-title-wrapper">
        <span id="nav-title">Template Haskell 旅程 -- 第一弹</span>
        <span id="nav-date">Written @<2024-02-03 Sat 12:00></span>
      </div>
    </div>
  </div>
</div>

<!-- The Modal -->
<div id="img-modal" class="modal">
  <!-- The Close Button -->
  <span class="close">&times;</span>
  <!-- Modal Content (The Image) -->
  <img class="modal-content" id="img-wrapper">
  <!-- Modal Caption (Image Text) -->
  <div id="caption"></div>
</div>
</div>
<div id="content" class="content">
<header>
<h1 class="title">Template Haskell 旅程 &#x2013; 第一弹</h1>
</header><nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgb34b51a">1. 前言</a></li>
<li><a href="#org1011671">2. 动机</a></li>
<li><a href="#org09cf647">3. <code>Q Monad</code></a></li>
<li><a href="#org3934716">4. Splicing</a></li>
</ul>
</div>
</nav>
<!-- more -->

<div id="outline-container-orgb34b51a" class="outline-2">
<h2 id="orgb34b51a"><span class="section-number-2">1.</span> 前言</h2>
<div class="outline-text-2" id="text-1">
<p>
此博客翻译自 Mark Karpov 大佬的 <a href="https://markkarpov.com/tutorial/th.html">Template Haskell Tutorial</a> 教程。
</p>

<p>
以下是 Mark Karpov 在博客中的前言：
</p>

<blockquote>
<p>
此教程的目的是向读者介绍 Template Haskell（以下简称 TH）作为 Haskell 语言的扩展，如何向 Haskell 语言提供元编程的能力。以下教程中我将假定读者具有一定的 Haskell 基础，用更通俗的话说，如果你知道什么是 Monad 那么阅读此教程的问题就不大。
</p>

<p>
TH 总是被认为是一个高阶的话题，一般人都理解不了，但我不认为如此。TH 背后的原理是简单并且合乎逻辑的，其内部细节可以在 Haddock 中找到。
</p>

<p>
本教程不可能对 TH 的使用方法面面俱到，但我会尽可能展示 TH 作为 GHC 特性中最常用、最实用、最易用的部分。
</p>
</blockquote>
</div>
</div>

<div id="outline-container-org1011671" class="outline-2">
<h2 id="org1011671"><span class="section-number-2">2.</span> 动机</h2>
<div class="outline-text-2" id="text-2">
<p>
在使用 TH 中最主要的难点是确定它是否是我们解决手头上的问题的最好方法。使用代码生成代码通常说明编程语言提供的表达能力或者程序员的想法无法解决问题，此时元编程就是最后的选择。不管怎样，TH 是一种相当流行的技巧，了解一点可以以备不时之需。
</p>

<p>
TH 有以下应用：
</p>
<ul class="org-ul">
<li>自动继承类型类的实例仍是 TH 最主要的应用场景。虽说我们也可以通过泛型来解决同样的问题，但是可能会导致编译时间与使用 TH 的方法相比更长。因此 TH 仍是 <code>aeson</code> 和 <code>lens</code> 等库实现中倾向于使用的自动化实例继承的方法；</li>
<li>创建能集成在 Haskell 当中构建的 TH DSL 语言，此类 DSL 语言能在 <a href="https://hackage.haskell.org/package/persistent">persistent</a> 作为模型声明语言，或者在例如 <a href="https://hackage.haskell.org/package/yesod">yesod</a> 网络框架中作为一些迷你语言；</li>
<li>在编译期构造变量并将非法的输入显示为编译错误；</li>
<li>在编译期加载和处理外部文件的数据，有些时候会很有用。虽说这会导致在编译期引入 <code>IO</code> ，但好过使用一些更危险的特性来实现功能。</li>
</ul>

<p>
不使用 TH 的理由：
</p>
<ul class="org-ul">
<li>TH 的帮助函数通常被视为“魔法”黑盒。我们根本不清楚 <code>Q [Dec]</code> 类型会做什么事情，它可以做任何事（后面我们会看到，生成声明的代码不管生成什么样的声明，都是相同的 <code>Q [Dec]</code> 类型）。大部分时候只能通过文档解释 TH 代码语义。</li>
<li>当用户自己实现 TH 函数以及需要在文件中对函数定义进行排序时，就会发现 TH 存在一些限制。</li>
</ul>
</div>
</div>

<div id="outline-container-org09cf647" class="outline-2">
<h2 id="org09cf647"><span class="section-number-2">3.</span> <code>Q Monad</code></h2>
<div class="outline-text-2" id="text-3">
<p>
想要生成代码我们需要以下的特性：
</p>

<ul class="org-ul">
<li>生成不可被捕获并且独一无二的名字的能力；</li>
<li>通过一个东西的名字恢复出它的信息的能力。通过我们对函数和类型感兴趣，但也需要方法获取模块、特定类型类的所有实例等信息；</li>
<li>获取和设置能够被同一个模块中所有 TH 代码共享的自定义状态的能力；</li>
<li>在编译期运行 <code>IO</code> 的能力，以便我们可以从文件中读取一些东西。</li>
</ul>

<p>
这些特性在 Haskell 中通常是通过 <code>Monad</code> 实现，那么有一个名为 <code>Q</code> 的 Monad 也就不奇怪了（此处 Q 为“引用”的缩写）， <code>Q</code> Monad 用于管理 TH 提供的所有函数。
</p>
</div>
</div>

<div id="outline-container-org3934716" class="outline-2">
<h2 id="org3934716"><span class="section-number-2">4.</span> Splicing</h2>
<div class="outline-text-2" id="text-4">
<p>
类型 <code>Q a</code> 的值的唯一作用是在 Haskell 程序中使用类型 <code>a</code> 。 <code>a</code> 可以是任何间接的 monadic 表达式，但当我们在 Haskell 文件中插入生成的代码时，只有以下 5 种选择：
</p>

<ul class="org-ul">
<li>声明 <code>Dec</code> ：用于表示像函数或者类型定义等&lt;ruby&gt;顶层的&lt;rt&gt;top-level&lt;/rt&gt;&lt;/ruby&gt;东西。</li>
</ul>
</div>
</div>
</div>
<div id="postamble" class="status">
<div id="author-info">
      <div id="author">Author: Cycoe (cycoejoo@163.com)</div>
      <div id="date">Date: <2024-02-03 Sat 12:00></div>
      <div id="generator">Generator: <a href="https://www.gnu.org/software/emacs/">Emacs</a> 29.2 (<a href="https://orgmode.org">Org</a> mode 9.6.15)</div>
      <div id="built">Built: <2024-02-03 Sat 20:42></div>
      </div><div id="copyright">
    <img id="cc" src="/static/img/Cc-logo-128x128.png" height="14px" width="14px"/>本站文章如未特殊声明，默认采用<a href="http://creativecommons.org/licenses/by-nc-sa/2.5/cn/" target="_blank">署名-非商业性使用-相同方式共享 2.5 中国大陆</a>进行许可。
</div>
</div>
</body>
</html>
