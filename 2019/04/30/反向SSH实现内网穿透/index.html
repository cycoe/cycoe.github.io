<!DOCTYPE html>





<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 3.7.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.4.1">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.4.1">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.4.1">
  <link rel="mask-icon" href="/images/logo.svg?v=7.4.1" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.4.1">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '7.4.1',
    exturl: false,
    sidebar: {"position":"right","display":"post","offset":12,"onmobile":true},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: '',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="最近实验室又配置了一台新的计算平台，噪声堪比飞机起飞，再加上本校区不允许实验过夜，只能将其安置在学校外面。但从学校到计算平台车程 40Km，每次都过去做计算显然不现实，如果能从学校直接远程连接是最好的。 通过相关资料的查询及对专业人士的请教，找到如下几种解决方法:  联系网络运营商将动态 IP 转为静态的公网 IP，这样就可以直接从学校的内网连接到计算平台，是最完美的解决方案。但是查询资费后发现，">
<meta name="keywords" content="Python, Linux, 化学">
<meta property="og:type" content="article">
<meta property="og:title" content="反向SSH实现内网穿透">
<meta property="og:url" content="http://cycoe.cc/2019/04/30/反向SSH实现内网穿透/index.html">
<meta property="og:site_name" content="Cycoe&#39;s Home Page">
<meta property="og:description" content="最近实验室又配置了一台新的计算平台，噪声堪比飞机起飞，再加上本校区不允许实验过夜，只能将其安置在学校外面。但从学校到计算平台车程 40Km，每次都过去做计算显然不现实，如果能从学校直接远程连接是最好的。 通过相关资料的查询及对专业人士的请教，找到如下几种解决方法:  联系网络运营商将动态 IP 转为静态的公网 IP，这样就可以直接从学校的内网连接到计算平台，是最完美的解决方案。但是查询资费后发现，">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://cycoe.cc/2019/04/30/反向SSH实现内网穿透/topology.png">
<meta property="og:updated_time" content="2019-05-03T14:07:52.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="反向SSH实现内网穿透">
<meta name="twitter:description" content="最近实验室又配置了一台新的计算平台，噪声堪比飞机起飞，再加上本校区不允许实验过夜，只能将其安置在学校外面。但从学校到计算平台车程 40Km，每次都过去做计算显然不现实，如果能从学校直接远程连接是最好的。 通过相关资料的查询及对专业人士的请教，找到如下几种解决方法:  联系网络运营商将动态 IP 转为静态的公网 IP，这样就可以直接从学校的内网连接到计算平台，是最完美的解决方案。但是查询资费后发现，">
<meta name="twitter:image" content="http://cycoe.cc/2019/04/30/反向SSH实现内网穿透/topology.png">
  <link rel="canonical" href="http://cycoe.cc/2019/04/30/反向SSH实现内网穿透/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title>反向SSH实现内网穿透 | Cycoe's Home Page</title>
  








  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Cycoe's Home Page</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">Simple is better than complex. Complex is better than complicated.</p>
      
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
        
        
        <li class="menu-item menu-item-home">
      
    

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
      
    
      
      
        
        
        <li class="menu-item menu-item-tags">
      
    

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签</a>

  </li>
      
    
      
      
        
        
        <li class="menu-item menu-item-categories">
      
    

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类</a>

  </li>
      
    
      
      
        
        
        <li class="menu-item menu-item-archives">
      
    

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档</a>

  </li>
      
    
      
      
        
        
        <li class="menu-item menu-item-about">
      
    

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
      
    
  </ul>

    

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://cycoe.cc/2019/04/30/反向SSH实现内网穿透/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Cycoe">
      <meta itemprop="description" content="Cycoe's Personal Blog">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Cycoe's Home Page">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            反向SSH实现内网穿透
            

          
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2019-04-30 23:42:57" itemprop="dateCreated datePublished" datetime="2019-04-30T23:42:57+08:00">2019-04-30</time>
            </span>
          
            

            
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2019-05-03 22:07:52" itemprop="dateModified" datetime="2019-05-03T22:07:52+08:00">2019-05-03</time>
              </span>
            
          

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
        
      
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2019/04/30/反向SSH实现内网穿透/#comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2019/04/30/反向SSH实现内网穿透/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>最近实验室又配置了一台新的计算平台，噪声堪比飞机起飞，再加上本校区不允许实验过夜，只能将其安置在学校外面。但从学校到计算平台车程 40Km，每次都过去做计算显然不现实，如果能从学校直接远程连接是最好的。</p>
<p>通过相关资料的查询及对专业人士的请教，找到如下几种解决方法:</p>
<ol>
<li>联系网络运营商将动态 IP 转为静态的公网 IP，这样就可以直接从学校的内网连接到计算平台，是最完美的解决方案。但是查询资费后发现，价钱不那么完美，一个月 6000 块大洋怎么负担得起啊！</li>
<li>主机 A 使用 TeamViewer 连接至计算平台局域网下的另一台主机 B，再控制 B 使用 SSH 连接至计算平台。这种方法包含几个明显的弊端：<ol>
<li>操作麻烦，需要经过两层的文件传输及控制；</li>
<li>虽然 TeamViewer 有个人的免费使用许可，但最近审查日益严格，经常使用几分钟就被强制下线；</li>
<li>TeamViewer 基于 GUI 远程控制，对网络要求很高；</li>
<li>最重要的一点，一个好的解决方案应该形成一个“黑箱”，而不应该把内部细节暴露给用户；</li>
</ol>
</li>
<li>从计算平台使用反向 SSH 连接到云服务器，从而建立起从云服务器到计算平台的隧道连接。这种方法传输的速度上限在于云服务器的带宽，最大的优点在于实现了一个“鸭子类型”，使用 SSH 连接计算平台与连接局域网内的主机无异。</li>
</ol>
<h2 id="SSH-协议与应用"><a href="#SSH-协议与应用" class="headerlink" title="SSH 协议与应用"></a>SSH 协议与应用</h2><blockquote>
<p>SSH 为 Secure Shell 的缩写，由 IETF 的网络小组（Network Working Group）所制定；SSH 为建立在应用层基础上的安全协议。SSH 是目前较可靠，专为远程登录会话和其他网络服务提供安全性的协议。利用 SSH 协议可以有效防止远程管理过程中的信息泄露问题。SSH 最初是 UNIX 系统上的一个程序，后来又迅速扩展到其他操作平台。SSH 在正确使用时可弥补网络中的漏洞。SSH 客户端适用于多种平台。几乎所有 UNIX 平台—包括 HP-UX、Linux、AIX、Solaris、Digital UNIX、Irix，以及其他平台，都可运行 SSH。</p>
</blockquote>
<p>以上对 SSH 的解释来自<a href="https://baike.baidu.com/item/ssh/10407?fr=aladdin" target="_blank" rel="noopener">百度百科</a>，别问我为什么不用 Wikipedia。从中我们看到，SSH 是建立在应用层基础上的一种安全协议，可以用来进行远程控制，或在计算机之间传送文件，比传统的 telnet 或 ftp 协议要更安全。Linux 下最常使用的就是 OpenSSH。OpenSSH 是 SSH 协议的免费开源实现，提供了服务端后台程序（SSH Daemon）和客户端工具(SSH Client)。主机可以通过 SSH 客户端连接运行了 SSH 服务端的主机。</p>
<h2 id="网络拓扑分析"><a href="#网络拓扑分析" class="headerlink" title="网络拓扑分析"></a>网络拓扑分析</h2><p>互联网是一张巨大的网，其中所有的主机都由有线或无线的方式相连，但并不代表任意两台主机都能互相可见。网络是有方向的，与其说是网我觉得更像一棵树。网络在向下进行传输时，会经过 NAT（Network Address Translation 网络地址转换），因此外网的主机无法直接访问内网的主机。</p>
<p>在我们本次遇到的问题中，网络连接可表示为如下的拓扑结构。<br><img src="/2019/04/30/反向SSH实现内网穿透/topology.png" title="网络拓扑结构"></p>
<p>各个主机的 IP 地址如下表所示</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>主机名</th>
<th>IP</th>
<th>用户名</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>计算平台 A</td>
<td>10.0.0.100</td>
<td>cal</td>
<td>目标主机，处于内网</td>
</tr>
<tr>
<td>控制端 B</td>
<td>192.168.1.100</td>
<td>client</td>
<td>控制主机，处于内网</td>
</tr>
<tr>
<td>云服务器 O</td>
<td>123.123.123.123</td>
<td>server</td>
<td>公网服务器，起桥梁作用</td>
</tr>
</tbody>
</table>
</div>
<p>其中 A、B 能够访问 O，但 O 不能访问 A、B，并且 A、B 之间不能直接互相访问。我们最后要实现的目标就是使用 B 访问 A。</p>
<h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><p>通俗地说：就是在主机 A 上做到 O 的反向代理；然后在 O 上做正向的代理实现本地端口的转发。</p>
<h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><p>A、B、O 上都要安装 SSH Client，A、O 上需要安装 SSH Daemon。</p>
<p>需要用到的 ssh 参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">反向代理</span><br><span class="line">ssh -fCNR</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">正向代理</span><br><span class="line">ssh -fCNL</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-f 后台执行 ssh 指令</span><br><span class="line">-C 允许压缩数据</span><br><span class="line">-N 不执行远程指令</span><br><span class="line">-R 将远程主机（服务器）的某个端口转发到本地端指定主机的指定端口</span><br><span class="line">-L 将本地机（客户机）的某个端口转发到远端指定主机的指定端口</span><br><span class="line">-p 指定远程主机的端口</span><br></pre></td></tr></table></figure>
<h3 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h3><p>首先在 A 主机上操作，建立 A 到 O 的反向代理，具体命令为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -fCNR [O 主机 IP 或省略]:[O 主机端口]:[A 主机 IP ]:[A 主机端口] [O 主机的用户名@O 主机 IP]</span><br></pre></td></tr></table></figure></p>
<p>在这里我使用了 O 主机的 3333 端口，以及 A 主机的 22 端口，按照以上命令即为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -fCNR 3333:localhost:22 server@123.123.123.123</span><br></pre></td></tr></table></figure></p>
<p>此时我们就将 O 的 3333 端口映射到了 A 的 22 端口，也就是说访问 O 的 3333 端口与访问 A 的 22 端口效果相同。</p>
<p>使用 <code>ps aux | grep 3333</code> 命令来查看反向代理是否运行成功。</p>
<h3 id="正向代理"><a href="#正向代理" class="headerlink" title="正向代理"></a>正向代理</h3><p>接下来在 O 主机上操作。完成上一步的反向代理后，在主机 O 上运行如下命令应该就可以登陆 A 主机。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -p 3333 cal@localhost</span><br></pre></td></tr></table></figure></p>
<p>该命令的含义为，使用 cal 用户登陆本机的 3333 端口。上面已经说过，访问 O 的 3333 端口与访问 A 的 22 端口效果相同，那么我们就成功从  O 主机登陆了 A 主机。</p>
<p>但此时我们仍只能从 O 主机本机上登陆 A 主机，无法从其他主机登陆，因此需要再对 3333 端口进行一次端口转发，使其他主机可以访问。具体命令为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -fCNL [O 主机 IP 或省略]:[转发端口]:[O 主机 IP]:[被转发端口] [登陆 O 主机的用户名@O 主机的 IP]</span><br></pre></td></tr></table></figure></p>
<p>此处我们想要将 3333 端口转发到 2222 端口，因此转发端口为 2222，被转发端口为 3333。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -fCNL *:2222:localhost:3333 localhost</span><br></pre></td></tr></table></figure></p>
<p>此处 <code>*</code> 表示允许任意其他主机访问，本机的用户名可省略。使用 <code>ps aux | grep 2222</code> 命令来查看正向代理是否运行成功。此处 2222 端口为本地转发端口，负责与外网进行通信，并将数据转发到 3333 端口，实现了可以从其他主机访问的功能。</p>
<h3 id="展现奇迹的时候到了"><a href="#展现奇迹的时候到了" class="headerlink" title="展现奇迹的时候到了"></a>展现奇迹的时候到了</h3><p>到次为至，我们已经配置好了 AO 主机，那么我们可以从任意可联网的设备登录到计算平台中去啦。指令为<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh -p 2222 cal@123.123.123.123</span><br></pre></td></tr></table></figure></p>
<p>我们实现了从任意地方连入内网计算平台的连接！</p>
<h3 id="这种反向代理是不稳定的"><a href="#这种反向代理是不稳定的" class="headerlink" title="这种反向代理是不稳定的"></a>这种反向代理是不稳定的</h3><p>不幸的是这种 ssh 连接会因为超时和网络堵塞等原因而关闭，那么从的外网连通内网的通道就无法维持了，为此我们需要维持稳定 ssh 反向代理隧道的方法。</p>
<h4 id="配置-ssh-key-实现免密登陆"><a href="#配置-ssh-key-实现免密登陆" class="headerlink" title="配置 ssh key 实现免密登陆"></a>配置 ssh key 实现免密登陆</h4><p>在使用 ssh 进行连接时，每次都需要输入密码，一方面不安全，另一方面也为我们接下来使用的自动化工具带来了阻碍。</p>
<p>首先登陆 A 主机，并运行如下命令生成公钥私钥对。中间的配置过程一路回车即可。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-keygen -t rsa -C <span class="string">"youremail@example.com"</span></span><br></pre></td></tr></table></figure></p>
<p>此时就在 A 主机的 <code>~/.ssh/</code> 目录下生成了公钥与私钥对，接下来我们需要将公钥传到 O 主机上作为我们登陆的一个比对凭证<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh-copy-id server@123.123.123.123</span><br></pre></td></tr></table></figure></p>
<p>此时，我们再使用 <code>ssh server@123.123.123.123</code> 登陆路 O 主机就不再需要密码了。</p>
<h4 id="用-autossh-建立稳定隧道"><a href="#用-autossh-建立稳定隧道" class="headerlink" title="用 autossh 建立稳定隧道"></a>用 autossh 建立稳定隧道</h4><p>从 A 主机到 O 主机的反向代理连接是不稳定的，也就是说，我们需要一个工具来时刻监听着这个连接。一但断开，再次自动重新建立连接即可。幸运的是，已经有人写出了这个工具，那就是 autossh！感谢开源！</p>
<p>CentOS 的官方仓库中并没有这个软件包，我们需要从源码编译安装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install wget gcc make</span><br><span class="line">wget http://www.harding.motd.ca/autossh/autossh-1.4e.tgz</span><br><span class="line">tar -xf autossh-1.4e.tgz</span><br><span class="line"><span class="built_in">cd</span> autossh-1.4e</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure></p>
<p>至此我们已经安装好了 autossh，利用下面的命令来启动守护进程。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">autossh -M 7200 -fCNR 3333:localhost:22 server@123.123.123.123</span><br></pre></td></tr></table></figure></p>
<p>autossh 命令的参数与 ssh 一致，不同的是我们需要指出的 <code>-M`` </code>参数，这个参数指定一个端口，这个端口是外网的 O 主机用来接收内网 A 主机的信息，如果隧道不正常而返回给 A 主机让它实现重新连接。</p>
<h4 id="配置自动启动"><a href="#配置自动启动" class="headerlink" title="配置自动启动"></a>配置自动启动</h4><p>我们需要将 autossh 命令配置在开机自动启动脚本中，免去了每次开机都需要重新运行脚本的麻烦。</p>
<p>我们需要在 A 主机的 <code>/etc/rc.d/rc.local</code> 文件中添加如下内容<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/bin/su -c <span class="string">'/usr/local/bin/autossh -M 7200 -fCNR 3333:localhost:22 server@123.123.123.123'</span> - cal</span><br></pre></td></tr></table></figure></p>
<p>此命令表示，以 cal 用户运行 autossh 命令，这样我们就能够使用 cal 用户反向连接到 A 主机。</p>
<p>为了保险起见，我们需要为自启动脚本添加执行权限<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod +x /etc/rc.d/rc.local</span><br></pre></td></tr></table></figure></p>
<p>至此我们就建立好了稳定的连接隧道。</p>
<h3 id="进一步优化"><a href="#进一步优化" class="headerlink" title="进一步优化"></a>进一步优化</h3><h4 id="保持活连接"><a href="#保持活连接" class="headerlink" title="保持活连接"></a>保持活连接</h4><p>在测试中发现，如果一个连接长时间空置，那么就会冻结。反向代理连接也是一样，此时便只能通过重启 A 主机使连接重置。为保持一个活连接（Keep alive），需要服务端或客户端定时发送心跳包来确保连接活跃，此处我们选择配置服务端的心跳。</p>
<p>在 A 和 O 的 <code>/etc/ssh/sshd_config</code> 文件中添加如下内容<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># server 每隔 60 秒发送一次请求给 client，然后 client 响应，从而保持连接</span></span><br><span class="line">ClientAliveInterval 60</span><br><span class="line"><span class="comment"># server 发出请求后，客户端没有响应得次数达到 3，就自动断开连接，正常情况下，client 不会不响应</span></span><br><span class="line">ClientAliveCountMax 3</span><br></pre></td></tr></table></figure></p>
<h4 id="Windows-SSH-Client-连接提示错误"><a href="#Windows-SSH-Client-连接提示错误" class="headerlink" title="Windows SSH Client 连接提示错误"></a>Windows SSH Client 连接提示错误</h4><p>使用 Windows 的 SSH Client 连接 Linux 运行的 SSH 服务端时，会提示“ssh algorithm negotiation failed”错误，导致此问题的原因是 ssh 升级后，为了安全，默认不再采用原来一些加密算法，我们手工添加进去即可。</p>
<p>在 O 主机的 <code>/etc/ssh/sshd_config</code> 文件中添加如下内容<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># add crypt format for window ssh client</span></span><br><span class="line">Ciphers aes128-cbc,aes192-cbc,aes256-cbc,aes128-ctr,aes192-ctr,aes256-ctr,3des-cbc,arcfour128,arcfour256,arcfour,blowfish-cbc,cast128-cbc</span><br><span class="line">MACs hmac-md5,hmac-sha1,umac-64@openssh.com,hmac-ripemd160,hmac-sha1-96,hmac-md5-96</span><br><span class="line">KexAlgorithms diffie-hellman-group1-sha1,diffie-hellman-group14-sha1,diffie-hellman-group-exchange-sha1,diffie-hellman-group-exchange-sha256,ecdh-sha2-nistp256,ecdh-sha2-nistp384,ecdh-sha2-nistp521,diffie-hellman-group1-sha1,curve25519-sha256@libssh.org</span><br></pre></td></tr></table></figure></p>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p> <a href="https://www.cnblogs.com/zjutlitao/p/6223486.html" target="_blank" rel="noopener">Windows SSH Client 报 Algorithm negotiation failed 的解决方法之一</a><br> <a href="https://blog.csdn.net/jiangbenchu/article/details/84438959" target="_blank" rel="noopener">使用SSH反向隧道进行内网穿透</a></p>

    </div>

    
    
    
        
      

      <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
              
                <a href="/2019/04/30/路由器配置教程/" rel="next" title="路由器配置教程">
                  <i class="fa fa-chevron-left"></i> 路由器配置教程
                </a>
              
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
              
                <a href="/2019/05/09/常用粤语语气词发音与含义/" rel="prev" title="常用粤语语气词发音与含义">
                  常用粤语语气词发音与含义 <i class="fa fa-chevron-right"></i>
                </a>
              
            </div>
          </div>
        
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    
    <div class="comments" id="comments"></div>
  

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">
        
        
        
        
      

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#SSH-协议与应用"><span class="nav-number">1.</span> <span class="nav-text">SSH 协议与应用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#网络拓扑分析"><span class="nav-number">2.</span> <span class="nav-text">网络拓扑分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#解决方法"><span class="nav-number">3.</span> <span class="nav-text">解决方法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#准备工作"><span class="nav-number">3.1.</span> <span class="nav-text">准备工作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#反向代理"><span class="nav-number">3.2.</span> <span class="nav-text">反向代理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#正向代理"><span class="nav-number">3.3.</span> <span class="nav-text">正向代理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#展现奇迹的时候到了"><span class="nav-number">3.4.</span> <span class="nav-text">展现奇迹的时候到了</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#这种反向代理是不稳定的"><span class="nav-number">3.5.</span> <span class="nav-text">这种反向代理是不稳定的</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#配置-ssh-key-实现免密登陆"><span class="nav-number">3.5.1.</span> <span class="nav-text">配置 ssh key 实现免密登陆</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#用-autossh-建立稳定隧道"><span class="nav-number">3.5.2.</span> <span class="nav-text">用 autossh 建立稳定隧道</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置自动启动"><span class="nav-number">3.5.3.</span> <span class="nav-text">配置自动启动</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#进一步优化"><span class="nav-number">3.6.</span> <span class="nav-text">进一步优化</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#保持活连接"><span class="nav-number">3.6.1.</span> <span class="nav-text">保持活连接</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Windows-SSH-Client-连接提示错误"><span class="nav-number">3.6.2.</span> <span class="nav-text">Windows SSH Client 连接提示错误</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考文献"><span class="nav-number">4.</span> <span class="nav-text">参考文献</span></a></li></ol></div>
        
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Cycoe</p>
  <div class="site-description" itemprop="description">Cycoe's Personal Blog</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">30</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
          
            <a href="/categories/">
          
        
        <span class="site-state-item-count">14</span>
        <span class="site-state-item-name">分类</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">标签</span>
        </a>
      </div>
    
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="https://github.com/cycoe" title="GitHub &rarr; https://github.com/cycoe" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
    
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Cycoe</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v3.7.1
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">
      
    主题 – <a href="https://mist.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> v7.4.1
  </div>

        












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js?v=3.1.0"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
<script src="/js/utils.js?v=7.4.1"></script><script src="/js/motion.js?v=7.4.1"></script>
<script src="/js/schemes/muse.js?v=7.4.1"></script>

<script src="/js/next-boot.js?v=7.4.1"></script>



  





















  

  

  

  


<script>
NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
  var GUEST = ['nick', 'mail', 'link'];
  var guest = 'nick,mail,link';
  guest = guest.split(',').filter(item => {
    return GUEST.includes(item);
  });
  new Valine({
    el: '#comments',
    verify: false,
    notify: false,
    appId: 'JMPgCt4i5QXYiepmd7ADdLfm-gzGzoHsz',
    appKey: 'z6zWp6MXVNc4WnbBOCkVw3Ir',
    placeholder: "此处评论",
    avatar: 'mm',
    meta: guest,
    pageSize: '10' || 10,
    visitor: false,
    lang: '' || 'zh-cn',
    path: location.pathname,
    recordIP: false,
    serverURLs: ''
  });
}, window.Valine);
</script>

</body>
</html>
